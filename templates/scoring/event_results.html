{% extends "base.html" %}

{% block title %}{{ event.display_name }} Results - {{ tournament.name }}{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    {% set list_only_event = event.event_type == 'college' and event.name in ['Axe Throw', 'Peavey Log Roll', 'Caber Toss', 'Pulp Toss'] %}
    <div class="row mb-4">
        <div class="col-12">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="{{ url_for('main.index') }}">Home</a></li>
                    <li class="breadcrumb-item"><a href="{{ url_for('main.tournament_detail', tournament_id=tournament.id) }}">{{ tournament.name }}</a></li>
                    <li class="breadcrumb-item"><a href="{{ url_for('scheduling.event_list', tournament_id=tournament.id) }}">Events</a></li>
                    <li class="breadcrumb-item active">{{ event.display_name }}</li>
                </ol>
            </nav>
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1>
                        <i class="bi bi-clipboard-data text-primary"></i>
                        {{ event.display_name }}
                    </h1>
                    <p class="text-muted mb-0">
                        <span class="badge bg-{{ 'primary' if event.event_type == 'college' else 'warning' }}">
                            {{ event.event_type|capitalize }}
                        </span>
                        <span class="badge bg-secondary">{{ event.scoring_type }}</span>
                        {% if event.requires_dual_runs %}
                            <span class="badge bg-info">Dual Runs</span>
                        {% endif %}
                        {% if event.is_partnered %}
                            <span class="badge bg-info">Partnered</span>
                        {% endif %}
                    </p>
                </div>
                <div>
                    {% if event.status != 'completed' %}
                        <form action="{{ url_for('scoring.finalize_event', tournament_id=tournament.id, event_id=event.id) }}"
                              method="POST" style="display:inline;"
                              data-confirm="Finalize this event and calculate positions?">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                            <button type="submit" class="btn btn-success">
                                <i class="bi bi-check-circle"></i> Finalize Event
                            </button>
                        </form>
                    {% endif %}
                    {% if event.event_type == 'pro' %}
                        <a href="{{ url_for('scoring.configure_payouts', tournament_id=tournament.id, event_id=event.id) }}"
                           class="btn btn-outline-warning">
                            <i class="bi bi-cash"></i> Configure Payouts
                        </a>
                    {% endif %}
                    {% if event.scoring_type == 'bracket' %}
                        <a href="{{ url_for('scoring.birling_bracket', tournament_id=tournament.id, event_id=event.id) }}"
                           class="btn btn-outline-info">
                            <i class="bi bi-diagram-3"></i> Bracket View
                        </a>
                    {% endif %}
                    <a href="{{ url_for('reporting.event_results_print', tournament_id=tournament.id, event_id=event.id) }}"
                       class="btn btn-outline-secondary" target="_blank">
                        <i class="bi bi-printer"></i> Print
                    </a>
                    <a href="{{ url_for('scoring.offline_ops', tournament_id=tournament.id) }}"
                       class="btn btn-outline-info">
                        <i class="bi bi-wifi-off"></i> Offline Ops
                    </a>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Heats List -->
        <div class="col-md-4 mb-4">
            <div class="card">
                <div class="card-header card-header-proam">
                    <h6 class="mb-0"><i class="bi bi-layers"></i> Heats</h6>
                </div>
                <div class="list-group list-group-flush">
                    {% if heats %}
                        {% for heat in heats %}
                        <a href="{{ url_for('scoring.enter_heat_results', tournament_id=tournament.id, heat_id=heat.id) }}"
                           class="list-group-item list-group-item-action d-flex justify-content-between align-items-center">
                            <span>
                                Heat {{ heat.heat_number }}
                                {% if event.requires_dual_runs %}
                                    - Run {{ heat.run_number }}
                                {% endif %}
                            </span>
                            <span>
                                {% if heat.status == 'completed' %}
                                    <span class="badge bg-success"><i class="bi bi-check"></i></span>
                                {% elif heat.status == 'in_progress' %}
                                    <span class="badge bg-primary">In Progress</span>
                                {% else %}
                                    <span class="badge bg-secondary">{{ heat.competitor_count }} competitors</span>
                                {% endif %}
                            </span>
                        </a>
                        {% endfor %}
                    {% else %}
                        <div class="list-group-item text-center text-muted py-4">
                            <i class="bi bi-inbox display-6"></i>
                            <p class="mt-2 mb-0">
                                {% if list_only_event %}
                                    This event uses signups only (no heats)
                                {% else %}
                                    No heats generated yet
                                {% endif %}
                            </p>
                        </div>
                    {% endif %}
                </div>
                {% if not heats and not list_only_event %}
                <div class="card-footer">
                    <form action="{{ url_for('scheduling.generate_heats', tournament_id=tournament.id, event_id=event.id) }}" method="POST">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                        <button type="submit" class="btn btn-proam w-100">
                            <i class="bi bi-shuffle"></i> Generate Heats
                        </button>
                    </form>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Results Table -->
        <div class="col-md-8">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h6 class="mb-0"><i class="bi bi-trophy"></i> Results</h6>
                    <span class="badge bg-{{ 'success' if event.status == 'completed' else 'secondary' }}">
                        {{ event.status|capitalize }}
                    </span>
                </div>
                <div class="card-body">
                    <div id="offlinePlacingsCard" class="alert alert-warning d-none mb-3">
                        <div class="d-flex justify-content-between align-items-center">
                            <strong><i class="bi bi-wifi-off"></i> Provisional Placings (Device Local)</strong>
                            <span id="offlinePendingCount" class="badge bg-warning text-dark">0 pending heats</span>
                        </div>
                        <div class="small mt-1 mb-2">These rankings include locally queued heat scores from this device that have not synced yet.</div>
                        <div id="offlinePlacingsBody" class="small"></div>
                    </div>

                    {% if results %}
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead class="table-proam">
                                <tr>
                                    <th>Pos</th>
                                    <th>Competitor</th>
                                    {% if event.is_partnered %}
                                        <th>Partner</th>
                                    {% endif %}
                                    {% if event.requires_dual_runs %}
                                        <th>Run 1</th>
                                        <th>Run 2</th>
                                        <th>Best</th>
                                    {% else %}
                                        <th>Result</th>
                                    {% endif %}
                                    {% if event.event_type == 'college' %}
                                        <th>Points</th>
                                    {% else %}
                                        <th>Payout</th>
                                    {% endif %}
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody id="resultsTableBody">
                                {% for r in results %}
                                <tr>
                                    <td>
                                        {% if r.final_position == 1 %}
                                            <span class="badge badge-gold">1st</span>
                                        {% elif r.final_position == 2 %}
                                            <span class="badge badge-silver">2nd</span>
                                        {% elif r.final_position == 3 %}
                                            <span class="badge badge-bronze">3rd</span>
                                        {% elif r.final_position %}
                                            {{ r.final_position }}
                                        {% else %}
                                            -
                                        {% endif %}
                                    </td>
                                    <td><strong>{{ r.competitor_name }}</strong></td>
                                    {% if event.is_partnered %}
                                        <td>{{ r.partner_name or '-' }}</td>
                                    {% endif %}
                                    {% if event.requires_dual_runs %}
                                        <td>{{ "%.2f"|format(r.run1_value) if r.run1_value else '-' }}</td>
                                        <td>{{ "%.2f"|format(r.run2_value) if r.run2_value else '-' }}</td>
                                        <td><strong>{{ "%.2f"|format(r.best_run) if r.best_run else '-' }}</strong></td>
                                    {% else %}
                                        <td>
                                            {% if r.result_value %}
                                                {% if event.scoring_type == 'time' %}
                                                    {{ "%.2f"|format(r.result_value) }}s
                                                {% elif event.scoring_type == 'hits' %}
                                                    {{ r.result_value|int }} hits
                                                {% elif event.scoring_type == 'distance' %}
                                                    {{ "%.1f"|format(r.result_value) }} ft
                                                {% else %}
                                                    {{ r.result_value }}
                                                {% endif %}
                                                {% if r.is_flagged %}
                                                <span class="badge bg-warning text-dark ms-1"
                                                      title="Score is an outlier (>2σ from event mean)">⚠</span>
                                                {% endif %}
                                            {% else %}
                                                -
                                            {% endif %}
                                        </td>
                                    {% endif %}
                                    {% if event.event_type == 'college' %}
                                        <td>
                                            {% if r.points_awarded %}
                                                <span class="badge bg-primary">{{ r.points_awarded }} pts</span>
                                            {% else %}
                                                -
                                            {% endif %}
                                        </td>
                                    {% else %}
                                        <td>
                                            {% if r.payout_amount %}
                                                <span class="text-success">${{ "%.2f"|format(r.payout_amount) }}</span>
                                            {% else %}
                                                -
                                            {% endif %}
                                        </td>
                                    {% endif %}
                                    <td>
                                        {% if r.status == 'completed' %}
                                            <span class="badge bg-success">Done</span>
                                        {% elif r.status == 'dnf' %}
                                            <span class="badge bg-danger">DNF</span>
                                        {% elif r.status == 'scratched' %}
                                            <span class="badge bg-secondary">Scratched</span>
                                        {% else %}
                                            <span class="badge bg-warning">Pending</span>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <div class="text-center py-5 text-muted">
                        <i class="bi bi-clipboard display-4"></i>
                        <p class="mt-3">No results recorded yet.</p>
                        <p class="small">Generate heats and enter results for each heat.</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function () {
    const QUEUE_KEY = 'proam_heat_score_queue_v1';
    const currentEventId = {{ event.id }};
    const scoringOrder = "{{ event.scoring_order }}";
    const requiresDualRuns = {{ 'true' if event.requires_dual_runs else 'false' }};
    const offlineCard = document.getElementById('offlinePlacingsCard');
    const offlineBody = document.getElementById('offlinePlacingsBody');
    const pendingBadge = document.getElementById('offlinePendingCount');

    function readQueue() {
        try {
            const parsed = JSON.parse(localStorage.getItem(QUEUE_KEY) || '[]');
            return Array.isArray(parsed) ? parsed : [];
        } catch (err) {
            return [];
        }
    }

    const seededResults = [
        {% for r in results %}
        {
            competitor_id: {{ r.competitor_id }},
            competitor_name: {{ r.competitor_name|tojson }},
            status: {{ r.status|tojson }},
            result_value: {{ 'null' if r.result_value is none else r.result_value }},
            run1_value: {{ 'null' if r.run1_value is none else r.run1_value }},
            run2_value: {{ 'null' if r.run2_value is none else r.run2_value }},
            best_run: {{ 'null' if r.best_run is none else r.best_run }}
        }{% if not loop.last %},{% endif %}
        {% endfor %}
    ];

    function applyQueuedHeat(resultMap, queuedHeat) {
        const names = queuedHeat.competitor_names || {};
        const payload = queuedHeat.payload || {};
        const runNumber = Number(queuedHeat.run_number || 1);

        Object.keys(payload).forEach(function (key) {
            if (!key.startsWith('result_')) return;
            const competitorId = Number(key.replace('result_', ''));
            const value = payload[key];
            if (value === null || value === undefined || value === '') return;

            const parsed = Number(value);
            if (Number.isNaN(parsed)) return;

            if (!resultMap[competitorId]) {
                resultMap[competitorId] = {
                    competitor_id: competitorId,
                    competitor_name: names[String(competitorId)] || ('Competitor #' + competitorId),
                    status: 'completed',
                    result_value: null,
                    run1_value: null,
                    run2_value: null,
                    best_run: null
                };
            }

            const row = resultMap[competitorId];
            row.status = payload['status_' + competitorId] || 'completed';

            if (requiresDualRuns) {
                if (runNumber === 1) row.run1_value = parsed;
                else row.run2_value = parsed;

                const runValues = [];
                if (row.run1_value !== null) runValues.push(Number(row.run1_value));
                if (row.run2_value !== null) runValues.push(Number(row.run2_value));
                if (runValues.length) {
                    row.best_run = scoringOrder === 'lowest_wins' ? Math.min.apply(null, runValues) : Math.max.apply(null, runValues);
                    row.result_value = row.best_run;
                }
            } else {
                row.result_value = parsed;
            }
        });
    }

    function renderOfflinePlacings() {
        const queue = readQueue().filter(function (entry) {
            return Number(entry.event_id) === currentEventId;
        });

        if (!queue.length) {
            offlineCard.classList.add('d-none');
            return;
        }

        const map = {};
        seededResults.forEach(function (result) {
            map[result.competitor_id] = Object.assign({}, result);
        });
        queue.forEach(function (entry) {
            applyQueuedHeat(map, entry);
        });

        const ranking = Object.values(map).filter(function (row) {
            return row.status === 'completed' && row.result_value !== null;
        });

        ranking.sort(function (a, b) {
            const av = Number(a.result_value);
            const bv = Number(b.result_value);
            return scoringOrder === 'lowest_wins' ? av - bv : bv - av;
        });

        const lines = ranking.slice(0, 12).map(function (row, index) {
            const label = (index + 1) + '. ' + row.competitor_name + ' - ' + Number(row.result_value).toFixed(2);
            return '<div>' + label + '</div>';
        });

        offlineBody.innerHTML = lines.length ? lines.join('') : '<div>No complete provisional results yet.</div>';
        pendingBadge.textContent = queue.length + ' pending heat(s)';
        offlineCard.classList.remove('d-none');
    }

    window.addEventListener('storage', function (event) {
        if (event.key === QUEUE_KEY) renderOfflinePlacings();
    });

    renderOfflinePlacings();
});
</script>
{% endblock %}
