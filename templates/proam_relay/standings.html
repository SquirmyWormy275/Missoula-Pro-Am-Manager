{% extends "base.html" %}

{% block title %}Pro-Am Relay Standings - {{ tournament.name }} {{ tournament.year }}{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="row mb-4">
        <div class="col-12">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="{{ url_for('proam_relay.relay_dashboard', tournament_id=tournament.id) }}">Pro-Am Relay</a></li>
                    <li class="breadcrumb-item active">Standings</li>
                </ol>
            </nav>
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1>
                        <i class="bi bi-trophy text-warning"></i>
                        Pro-Am Relay Standings
                    </h1>
                    <p class="text-muted">{{ tournament.name }} {{ tournament.year }}</p>
                </div>
                <div>
                    {% if status == 'completed' %}
                        <span class="badge bg-success fs-5">Competition Complete</span>
                    {% elif status == 'in_progress' %}
                        <span class="badge bg-warning text-dark fs-5">In Progress</span>
                    {% endif %}
                    <button class="btn btn-outline-primary ms-2" onclick="window.print()">
                        <i class="bi bi-printer"></i> Print
                    </button>
                </div>
            </div>
        </div>
    </div>

    {% if results %}
    <!-- Winner Display -->
    {% if status == 'completed' %}
    <div class="row mb-4">
        <div class="col-12">
            <div class="card bg-warning text-dark">
                <div class="card-body text-center py-4">
                    <i class="bi bi-trophy-fill display-3"></i>
                    <h2 class="mt-3">{{ results[0].name }} Wins!</h2>
                    <h4>Total Time: {{ "%.2f"|format(results[0].total_time) }} seconds</h4>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Standings Table -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0"><i class="bi bi-list-ol"></i> Final Standings</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead class="table-proam">
                                <tr>
                                    <th class="text-center" style="width: 60px;">Place</th>
                                    <th>Team</th>
                                    <th class="text-center">J&J Sawing</th>
                                    <th class="text-center">Standing Block</th>
                                    <th class="text-center">Underhand</th>
                                    <th class="text-end">Total Time</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for team in results %}
                                <tr class="{% if loop.index == 1 %}table-warning{% endif %}">
                                    <td class="text-center">
                                        {% if loop.index == 1 %}
                                            <span class="badge bg-warning text-dark fs-5"><i class="bi bi-trophy-fill"></i> 1st</span>
                                        {% elif loop.index == 2 %}
                                            <span class="badge bg-secondary fs-5">2nd</span>
                                        {% elif loop.index == 3 %}
                                            <span class="badge bg-info fs-5">3rd</span>
                                        {% else %}
                                            <span class="badge bg-light text-dark fs-5">{{ loop.index }}th</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <strong>{{ team.name }}</strong>
                                    </td>
                                    <td class="text-center">
                                        {{ "%.2f"|format(team.events.jj_sawing.result) }}s
                                    </td>
                                    <td class="text-center">
                                        {{ "%.2f"|format(team.events.standing_block.result) }}s
                                    </td>
                                    <td class="text-center">
                                        {{ "%.2f"|format(team.events.underhand.result) }}s
                                    </td>
                                    <td class="text-end">
                                        <strong class="fs-5">{{ "%.2f"|format(team.total_time) }}s</strong>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Team Details -->
    <div class="row mt-4">
        {% for team in results %}
        <div class="col-md-6 mb-4">
            <div class="card {% if loop.index == 1 %}border-warning border-3{% endif %}">
                <div class="card-header d-flex justify-content-between align-items-center
                    {% if loop.index == 1 %}bg-warning text-dark{% else %}bg-light{% endif %}">
                    <h5 class="mb-0">
                        {% if loop.index == 1 %}<i class="bi bi-trophy-fill"></i>{% endif %}
                        {{ team.name }}
                    </h5>
                    <span class="badge {% if loop.index == 1 %}bg-dark{% else %}bg-primary{% endif %} fs-6">
                        {{ loop.index }}{% if loop.index == 1 %}st{% elif loop.index == 2 %}nd{% elif loop.index == 3 %}rd{% else %}th{% endif %} Place
                    </span>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-6">
                            <h6 class="text-warning"><i class="bi bi-star-fill"></i> Pro</h6>
                            <ul class="list-unstyled mb-0">
                                {% for member in team.pro_members %}
                                <li>{{ member.name }}</li>
                                {% endfor %}
                            </ul>
                        </div>
                        <div class="col-6">
                            <h6 class="text-primary"><i class="bi bi-mortarboard-fill"></i> College</h6>
                            <ul class="list-unstyled mb-0">
                                {% for member in team.college_members %}
                                <li>{{ member.name }}</li>
                                {% endfor %}
                            </ul>
                        </div>
                    </div>
                </div>
                <div class="card-footer text-center">
                    <strong>Total Time: {{ "%.2f"|format(team.total_time) }}s</strong>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>

    {% elif teams %}
    <!-- Teams exist but no completed results -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0"><i class="bi bi-hourglass-split"></i> Competition In Progress</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead class="table-proam">
                                <tr>
                                    <th>Team</th>
                                    <th class="text-center">J&J Sawing</th>
                                    <th class="text-center">Standing Block</th>
                                    <th class="text-center">Underhand</th>
                                    <th class="text-center">Progress</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for team in teams %}
                                {% set completed = [team.events.jj_sawing, team.events.standing_block, team.events.underhand]|selectattr('status', 'equalto', 'completed')|list|length %}
                                <tr>
                                    <td><strong>{{ team.name }}</strong></td>
                                    <td class="text-center">
                                        {% if team.events.jj_sawing.result %}
                                            <span class="badge bg-success">{{ "%.2f"|format(team.events.jj_sawing.result) }}s</span>
                                        {% else %}
                                            <span class="badge bg-secondary">Pending</span>
                                        {% endif %}
                                    </td>
                                    <td class="text-center">
                                        {% if team.events.standing_block.result %}
                                            <span class="badge bg-success">{{ "%.2f"|format(team.events.standing_block.result) }}s</span>
                                        {% else %}
                                            <span class="badge bg-secondary">Pending</span>
                                        {% endif %}
                                    </td>
                                    <td class="text-center">
                                        {% if team.events.underhand.result %}
                                            <span class="badge bg-success">{{ "%.2f"|format(team.events.underhand.result) }}s</span>
                                        {% else %}
                                            <span class="badge bg-secondary">Pending</span>
                                        {% endif %}
                                    </td>
                                    <td class="text-center">
                                        <div class="progress" style="width: 100px; height: 20px; margin: 0 auto;">
                                            <div class="progress-bar bg-success" style="width: {{ (completed / 3) * 100 }}%">
                                                {{ completed }}/3
                                            </div>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    <div class="text-center mt-3">
                        <a href="{{ url_for('proam_relay.enter_results', tournament_id=tournament.id) }}" class="btn btn-success btn-lg">
                            <i class="bi bi-stopwatch"></i> Continue Entering Results
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% else %}
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-body text-center py-5">
                    <i class="bi bi-people display-1 text-muted"></i>
                    <h4 class="mt-4">No Teams Drawn Yet</h4>
                    <p class="text-muted">Run the lottery to create teams for the Pro-Am Relay.</p>
                    <a href="{{ url_for('proam_relay.relay_dashboard', tournament_id=tournament.id) }}" class="btn btn-warning btn-lg">
                        <i class="bi bi-shuffle"></i> Go to Lottery
                    </a>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
</div>

<style>
@media print {
    .breadcrumb, .btn, .no-print { display: none !important; }
    .card { border: 1px solid #ddd !important; }
}
</style>
{% endblock %}
